name: APEX Schema Auto-Diff Generator

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main

jobs:
  generate-schema-diff:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # CRITICAL: Fetch all history for all branches
        ref: ${{ github.ref }}
    
    - name: Fetch Main Branch Explicitly
      run: |
        echo "Fetching main branch..."
        git fetch origin main:main
        git branch -a
        echo "Current branch: $(git branch --show-current)"
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Create Output Directories
      run: |
        mkdir -p diff-reports
        mkdir -p migration-scripts
        echo "Directories created"
    
    - name: Create Schema Comparison Script
      run: |
        cat > compare_schemas.py << 'ENDCOMPARE'
        import re
        import os
        from pathlib import Path
        from datetime import datetime
        import subprocess

        class APEXSchemaComparator:
            def __init__(self):
                self.differences = []
                self.alter_statements = []
                self.current_branch = os.environ.get('GITHUB_REF', '').split('/')[-1]
                
            def extract_columns_from_ddl(self, ddl_content):
                """Extract column definitions from DDL with full details"""
                columns = {}
                in_create = False
                lines = ddl_content.split('\n')
                
                for i, line in enumerate(lines):
                    line_stripped = line.strip()
                    
                    if 'create table' in line_stripped.lower():
                        in_create = True
                        continue
                    
                    if in_create:
                        # Stop at constraints or end of CREATE TABLE
                        if (line_stripped.startswith('constraint') or 
                            line_stripped.startswith('primary key') or
                            line_stripped.startswith('foreign key') or
                            line_stripped.startswith(');') or
                            line_stripped.startswith('/')):
                            break
                        
                        # Match column definition
                        match = re.match(r'^(\w+)\s+(number|varchar2|date|timestamp|clob|blob|char)', line_stripped, re.IGNORECASE)
                        if match:
                            col_name = match.group(1).upper()
                            # Get full column definition including constraints
                            col_def = line_stripped.rstrip(',').strip()
                            columns[col_name] = col_def
                
                return columns
            
            def compare_tables(self, main_ddl, current_ddl, table_file):
                """Compare table definitions between branches"""
                table_name = Path(table_file).stem.upper()
                print(f"\n{'='*70}")
                print(f"Analyzing table: {table_name}")
                print(f"{'='*70}")
                
                if main_ddl:
                    print("✓ Successfully read from MAIN branch")
                    main_cols = self.extract_columns_from_ddl(main_ddl)
                    print(f"  Columns in MAIN: {sorted(main_cols.keys())}")
                else:
                    main_cols = {}
                    print("✗ Could not read from MAIN branch (treating as new table)")
                
                current_cols = self.extract_columns_from_ddl(current_ddl)
                print(f"  Columns in CURRENT ({self.current_branch}): {sorted(current_cols.keys())}")
                
                # Find differences
                new_cols = set(current_cols.keys()) - set(main_cols.keys())
                dropped_cols = set(main_cols.keys()) - set(current_cols.keys())
                
                print(f"\n  Changes detected:")
                print(f"    Added: {sorted(new_cols) if new_cols else 'None'}")
                print(f"    Dropped: {sorted(dropped_cols) if dropped_cols else 'None'}")
                
                # Generate ALTER statements for new columns
                for col in sorted(new_cols):
                    col_def = current_cols[col]
                    diff_msg = f"Added column '{col}'"
                    self.differences.append({
                        'table': table_name,
                        'type': 'ADD_COLUMN',
                        'message': diff_msg,
                        'column': col,
                        'definition': col_def
                    })
                    alter_stmt = f"ALTER TABLE {table_name} ADD {col_def};"
                    self.alter_statements.append(alter_stmt)
                    print(f"    [+] {col}")
                
                # Generate ALTER statements for dropped columns
                for col in sorted(dropped_cols):
                    diff_msg = f"Dropped column '{col}'"
                    self.differences.append({
                        'table': table_name,
                        'type': 'DROP_COLUMN',
                        'message': diff_msg,
                        'column': col
                    })
                    alter_stmt = f"ALTER TABLE {table_name} DROP COLUMN {col};"
                    self.alter_statements.append(alter_stmt)
                    print(f"    [-] {col}")
                
                return len(new_cols) + len(dropped_cols)
            
            def generate_reports(self):
                """Generate migration scripts and reports"""
                timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                branch = self.current_branch
                
                alter_file = Path(f"migration-scripts/migrate-{branch}.sql")
                alter_file.parent.mkdir(parents=True, exist_ok=True)
                
                with open(alter_file, 'w') as f:
                    f.write(f"-- =====================================================\n")
                    f.write(f"-- APEX Schema Migration Script\n")
                    f.write(f"-- =====================================================\n")
                    f.write(f"-- Source Branch: main\n")
                    f.write(f"-- Target Branch: {branch}\n")
                    f.write(f"-- Generated: {timestamp}\n")
                    f.write(f"-- Total Changes: {len(self.differences)}\n")
                    f.write(f"-- =====================================================\n\n")
                    
                    if self.alter_statements:
                        f.write(f"-- Run this script to migrate from main to {branch}\n\n")
                        for stmt in self.alter_statements:
                            f.write(f"{stmt}\n")
                        f.write(f"\n-- End of migration script\n")
                    else:
                        f.write("-- No schema changes detected\n")
                
                print(f"\n✓ Migration script created: {alter_file}")
                
                summary_file = Path(f"diff-reports/summary-{branch}.md")
                summary_file.parent.mkdir(parents=True, exist_ok=True)
                
                with open(summary_file, 'w') as f:
                    f.write(f"# Schema Changes: main → {branch}\n\n")
                    f.write(f"**Generated:** {timestamp}\n\n")
                    f.write(f"**Total Changes:** {len(self.differences)}\n\n")
                    f.write(f"---\n\n")
                    
                    if self.differences:
                        tables = {}
                        for diff in self.differences:
                            table = diff['table']
                            if table not in tables:
                                tables[table] = []
                            tables[table].append(diff)
                        
                        f.write("## Changes by Table\n\n")
                        for table, changes in tables.items():
                            f.write(f"### Table: {table}\n\n")
                            for change in changes:
                                f.write(f"- {change['type']}: {change['message']}\n")
                            f.write("\n")
                        
                        f.write("---\n\n")
                        f.write("## Migration SQL Script\n\n")
                        f.write("```
                        for stmt in self.alter_statements:
                            f.write(f"{stmt}\n")
                        f.write("```\n\n")
                    else:
                        f.write("No schema differences detected.\n")
                        f.write(f"The schema in branch {branch} is identical to main.\n")
                
                print(f"✓ Summary report created: {summary_file}")
                return len(self.differences)

        def main():
            print("=" * 70)
            print("APEX Schema Comparison Tool")
            print("=" * 70)
            
            comparator = APEXSchemaComparator()
            current_branch = comparator.current_branch
            
            print(f"\nCurrent Branch: {current_branch}")
            
            if current_branch == 'main':
                print("\n⚠ On main branch - no comparison needed")
                return
            
            schema_path = Path("src/database/wksp_ebs2cloud_migration/tables")
            
            if not schema_path.exists():
                print(f"\n✗ Schema path not found: {schema_path}")
                return
            
            print(f"✓ Schema Path: {schema_path}")
            
            sql_files = list(schema_path.glob("*.sql"))
            
            if not sql_files:
                print(f"\n✗ No SQL files found in {schema_path}")
                return
            
            print(f"✓ Found {len(sql_files)} SQL file(s)")
            
            total_changes = 0
            
            for sql_file in sql_files:
                current_ddl = sql_file.read_text()
                
                # Construct the correct git path
                git_path = f'src/database/wksp_ebs2cloud_migration/tables/{sql_file.name}'
                
                print(f"\n  Fetching from main branch: {git_path}")
                
                try:
                    # Try to get file from main branch
                    result = subprocess.run(
                        ['git', 'show', f'main:{git_path}'],
                        capture_output=True,
                        text=True,
                        check=False,
                        cwd=os.getcwd()
                    )
                    
                    if result.returncode == 0 and result.stdout.strip():
                        main_ddl = result.stdout
                        print(f"  ✓ Successfully read {len(main_ddl)} bytes from main")
                    else:
                        print(f"  ✗ Failed to read from main branch")
                        print(f"  Git error: {result.stderr[:300]}")
                        main_ddl = None
                        
                except Exception as e:
                    print(f"  ✗ Exception: {str(e)}")
                    main_ddl = None
                
                changes = comparator.compare_tables(main_ddl, current_ddl, sql_file)
                total_changes += changes
            
            print("\n" + "=" * 70)
            print("Generating Reports...")
            print("=" * 70)
            
            comparator.generate_reports()
            
            print("\n" + "=" * 70)
            print(f"✓ Comparison Complete: {total_changes} change(s) detected")
            print("=" * 70)

        if __name__ == "__main__":
            main()
        ENDCOMPARE
        
        echo "Comparison script created"
    
    - name: Compare Schemas
      if: github.ref != 'refs/heads/main'
      run: |
        echo "Starting schema comparison..."
        python3 compare_schemas.py
    
    - name: Upload Migration Scripts
      if: github.ref != 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: migration-scripts-${{ github.ref_name }}
        path: |
          migration-scripts/
          diff-reports/
        retention-days: 90
    
    - name: Create GitHub Actions Summary
      if: github.ref != 'refs/heads/main'
      run: |
        BRANCH_NAME=${GITHUB_REF##*/}
        if [ -f "diff-reports/summary-${BRANCH_NAME}.md" ]; then
          cat "diff-reports/summary-${BRANCH_NAME}.md" >> $GITHUB_STEP_SUMMARY
        else
          echo "## No Changes" >> $GITHUB_STEP_SUMMARY
          echo "Schema in branch matches main" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Comment on Pull Request
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const branchName = context.payload.pull_request.head.ref;
          const summaryPath = `diff-reports/summary-${branchName}.md`;
          if (fs.existsSync(summaryPath)) {
            const summary = fs.readFileSync(summaryPath, 'utf8');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Schema Changes\n\n${summary}\n\nDownload migration scripts from artifacts.`
            });
          }
    
    - name: Pipeline Complete
      run: |
        echo "✓ Schema comparison completed"
        echo "Branch: ${GITHUB_REF##*/}"